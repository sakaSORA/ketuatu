<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡€åœ§è¨˜éŒ² - PWAçµ±åˆç‰ˆ</title>
    
    <meta name="theme-color" content="#764ba2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">

    <style>
        /* --- åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ»ã‚¹ã‚¿ã‚¤ãƒ« --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 10px; }
        .header h1 { font-size: 1.4rem; }

        /* å…¥åŠ›ã‚«ãƒ¼ãƒ‰ */
        .input-card {
            background: white; border-radius: 16px; padding: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); margin-bottom: 15px;
        }
        .date-input {
            width: 100%; padding: 10px; border: 2px solid #e5e7eb;
            border-radius: 10px; font-size: 1.1rem; text-align: center; margin-bottom: 12px; font-weight: bold;
        }

        /* â˜€ï¸ æœã‚¨ãƒªã‚¢ãƒ»ğŸŒ™ å¤œã‚¨ãƒªã‚¢ã®è‰²ä»˜ã‘ */
        .area-morning {
            background-color: #fffaf0; border-radius: 12px; padding: 12px; margin-bottom: 12px;
            border: 1px solid #ffeeba;
        }
        .area-evening {
            background-color: #f0f7ff; border-radius: 12px; padding: 12px; margin-bottom: 12px;
            border: 1px solid #bee5eb;
        }

        .section-title { font-size: 1rem; font-weight: bold; margin-bottom: 10px; text-align: center; }
        .morning-text { color: #d68910; }
        .evening-text { color: #2e86de; }

        /* å…¥åŠ›ãƒ‘ãƒ¼ãƒ„ */
        .stepper-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px; }
        .reading-num { font-size: 0.9rem; font-weight: bold; background: #eee; padding: 4px 8px; border-radius: 6px; }
        .value-control { display: flex; align-items: center; gap: 4px; }
        .step-btn { width: 36px; height: 36px; border: 1px solid #ccc; background: white; border-radius: 6px; font-weight: bold; font-size: 1.2rem; cursor: pointer; }
        .value-control select { width: 70px; height: 38px; border: 1px solid #ccc; border-radius: 6px; font-size: 1.2rem; font-weight: bold; text-align: center; }

        /* ãƒœã‚¿ãƒ³ */
        .save-button {
            width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; cursor: pointer;
        }
        .tool-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .tool-btn { padding: 10px 5px; border-radius: 8px; border: none; color: white; font-weight: bold; font-size: 0.8rem; cursor: pointer; }
        .btn-print { background: #10b981; }
        .btn-export { background: #f39c12; }
        .btn-import { background: #7f8c8d; }

        /* å±¥æ­´ */
        .history-section { background: white; border-radius: 16px; padding: 15px; min-height: 150px; }
        .history-item { border-bottom: 1px solid #eee; }
        .history-summary { display: grid; grid-template-columns: 60px 1fr 1fr 40px; align-items: center; padding: 12px 0; cursor: pointer; }
        .history-date { font-weight: bold; color: #555; }
        .sum-val { font-size: 1.1rem; font-weight: bold; text-align: center; }
        .delete-btn { background: #ffeded; color: #eb4d4b; border: none; border-radius: 6px; padding: 6px; cursor: pointer; }
        .history-details {
            max-height: 0; overflow: hidden; background: #f8f9fa; transition: max-height 0.3s;
            text-align: center; font-size: 0.9rem; color: #666;
        }
        .history-item.open .history-details { max-height: 60px; padding: 8px 0; border-top: 1px dashed #ccc; }

        /* --- å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚° --- */
        .print-dialog-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px;
        }
        .print-dialog { background: white; border-radius: 16px; padding: 20px; max-width: 400px; width: 100%; }
        .dialog-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; }
        .dialog-section { margin-bottom: 12px; }
        .dialog-input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px; }
        .dialog-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .dialog-btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .dialog-btn.primary { background: #667eea; color: white; }
        .dialog-btn.secondary { background: #eee; }

        /* --- å°åˆ·ç”¨ã‚³ãƒ³ãƒ†ãƒŠãƒ»ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #printContainer { display: none; }
        @media print {
            body * { visibility: hidden; }
            #printContainer, #printContainer * { visibility: visible; }
            #printContainer { display: block !important; position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; }
            .print-page { page-break-after: always; display: grid; grid-template-columns: 1fr 1fr; gap: 5mm; padding: 10mm; }
            .print-header { grid-column: 1 / -1; text-align: center; border-bottom: 2px solid #000; margin-bottom: 5mm; padding-bottom: 2mm; }
            .week-group { border: 1px solid #333; padding: 2mm; display: flex; flex-direction: column; page-break-inside: avoid; }
            .weekly-summary { background: #eee; padding: 1mm; text-align: center; font-weight: bold; font-size: 9pt; margin-bottom: 2mm; }
            .day-row { display: grid; grid-template-columns: 15mm 1fr; border-bottom: 1px solid #ccc; padding: 1mm 0; min-height: 12mm; align-items: center; font-size: 8pt; }
            .day-date { font-weight: bold; text-align: center; }
            .day-values { display: grid; grid-template-columns: 1fr 1fr; text-align: center; }
            .val-m { color: #d68910; } .val-e { color: #2e86de; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>ğŸ©º è¡€åœ§è¨˜éŒ²</h1></div>

    <div class="input-card">
        <input type="date" id="record_date" class="date-input">

        <div class="area-morning">
            <div class="section-title morning-text">â˜€ï¸ æœã®æ¸¬å®š</div>
            <div class="stepper-row">
                <div class="reading-num">â‘ </div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('m1_sys', -1)">-</button>
                    <select id="m1_sys"></select>
                    <button class="step-btn" onclick="step('m1_sys', 1)">+</button>
                </div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('m1_dia', -1)">-</button>
                    <select id="m1_dia"></select>
                    <button class="step-btn" onclick="step('m1_dia', 1)">+</button>
                </div>
            </div>
            <div class="stepper-row">
                <div class="reading-num">â‘¡</div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('m2_sys', -1)">-</button>
                    <select id="m2_sys"></select>
                    <button class="step-btn" onclick="step('m2_sys', 1)">+</button>
                </div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('m2_dia', -1)">-</button>
                    <select id="m2_dia"></select>
                    <button class="step-btn" onclick="step('m2_dia', 1)">+</button>
                </div>
            </div>
        </div>

        <div class="area-evening">
            <div class="section-title evening-text">ğŸŒ™ å¤œã®æ¸¬å®š</div>
            <div class="stepper-row">
                <div class="reading-num">â‘ </div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('e1_sys', -1)">-</button>
                    <select id="e1_sys"></select>
                    <button class="step-btn" onclick="step('e1_sys', 1)">+</button>
                </div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('e1_dia', -1)">-</button>
                    <select id="e1_dia"></select>
                    <button class="step-btn" onclick="step('e1_dia', 1)">+</button>
                </div>
            </div>
            <div class="stepper-row">
                <div class="reading-num">â‘¡</div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('e2_sys', -1)">-</button>
                    <select id="e2_sys"></select>
                    <button class="step-btn" onclick="step('e2_sys', 1)">+</button>
                </div>
                <div class="value-control">
                    <button class="step-btn" onclick="step('e2_dia', -1)">-</button>
                    <select id="e2_dia"></select>
                    <button class="step-btn" onclick="step('e2_dia', 1)">+</button>
                </div>
            </div>
        </div>

        <button class="save-button" onclick="addRecord()">ğŸ’¾ è¨˜éŒ²ã‚’ä¿å­˜</button>

        <div class="tool-buttons">
            <button class="tool-btn btn-print" onclick="showPrintDialog()">ğŸ–¨ï¸ å°åˆ·</button>
            <button class="tool-btn btn-export" onclick="exportToCSV()">ğŸ“Š å‡ºåŠ›</button>
            <button class="tool-btn btn-import" onclick="document.getElementById('csvFile').click()">ğŸ“¥ å–è¾¼</button>
        </div>
        <input type="file" id="csvFile" style="display:none" onchange="importFromCSV(this)">
    </div>

    <div class="history-section">
        <h3 style="margin-bottom: 10px; font-size: 0.9rem;">ğŸ“‹ å±¥æ­´ (ã‚¿ãƒƒãƒ—ã§è©³ç´°)</h3>
        <div id="historyList"></div>
    </div>
</div>

<div class="print-dialog-overlay" id="printDialog">
    <div class="print-dialog">
        <div class="dialog-title">ğŸ–¨ï¸ å°åˆ·è¨­å®š</div>
        <div class="dialog-section">
            <label>é–‹å§‹æ—¥</label><input type="date" id="printStartDate" class="dialog-input">
        </div>
        <div class="dialog-section">
            <label>çµ‚äº†æ—¥</label><input type="date" id="printEndDate" class="dialog-input">
        </div>
        <div class="dialog-buttons">
            <button class="dialog-btn secondary" onclick="closePrintDialog()">é–‰ã˜ã‚‹</button>
            <button class="dialog-btn primary" onclick="executePrint()">å°åˆ·å®Ÿè¡Œ</button>
        </div>
    </div>
</div>

<div id="printContainer"></div>

<script>
    // --- 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    let records = JSON.parse(localStorage.getItem('bp_records_integrated')) || [];

    // --- 2. åˆæœŸåŒ– ---
    function createOptions(id, min, max, def) {
        const sel = document.getElementById(id);
        for(let i=max; i>=min; i--) {
            const opt = document.createElement('option');
            opt.value = i; opt.textContent = i;
            if(i === def) opt.selected = true;
            sel.appendChild(opt);
        }
    }
    ['m1','m2','e1','e2'].forEach(p => {
        createOptions(p+'_sys', 70, 220, 125);
        createOptions(p+'_dia', 40, 140, 80);
    });
    // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ãƒƒãƒˆ
    document.getElementById('record_date').value = new Date().toLocaleString('sv-SE', { timeZone: 'Asia/Tokyo' }).split(' ')[0];

    // --- 3. UIæ“ä½œ ---
    function step(id, val) {
        const el = document.getElementById(id);
        const nextVal = parseInt(el.value) + val;
        if(el.querySelector(`option[value="${nextVal}"]`)) el.value = nextVal;
    }

    function addRecord() {
        const dateVal = document.getElementById('record_date').value;
        const entry = {
            id: Date.now(),
            fullDate: dateVal,
            m1: [parseInt(document.getElementById('m1_sys').value), parseInt(document.getElementById('m1_dia').value)],
            m2: [parseInt(document.getElementById('m2_sys').value), parseInt(document.getElementById('m2_dia').value)],
            e1: [parseInt(document.getElementById('e1_sys').value), parseInt(document.getElementById('e1_dia').value)],
            e2: [parseInt(document.getElementById('e2_sys').value), parseInt(document.getElementById('e2_dia').value)]
        };
        // åŒã˜æ—¥ä»˜ãŒã‚ã‚Œã°ä¸Šæ›¸ãï¼ˆå‰Šé™¤ã—ã¦è¿½åŠ ï¼‰
        records = records.filter(r => r.fullDate !== dateVal);
        records.unshift(entry);
        records.sort((a,b) => new Date(b.fullDate) - new Date(a.fullDate));
        saveAndRender();
        alert('ä¿å­˜ã—ã¾ã—ãŸ');
    }

    function saveAndRender() {
        localStorage.setItem('bp_records_integrated', JSON.stringify(records));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        if (records.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ãªã—</div>';
            return;
        }
        list.innerHTML = records.map(r => {
            const d = new Date(r.fullDate);
            return `
                <div class="history-item" onclick="this.classList.toggle('open')">
                    <div class="history-summary">
                        <div class="history-date">${d.getMonth()+1}/${d.getDate()}</div>
                        <div class="sum-val morning-text">${r.m1[0]}/${r.m1[1]}</div>
                        <div class="sum-val evening-text">${r.e1[0]}/${r.e1[1]}</div>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteRecord(${r.id})">Ã—</button>
                    </div>
                    <div class="history-details">
                        <p>æœâ‘¡: ${r.m2[0]}/${r.m2[1]} | å¤œâ‘¡: ${r.e2[0]}/${r.e2[1]}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    function deleteRecord(id) {
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            records = records.filter(r => r.id !== id);
            saveAndRender();
        }
    }

    // --- 4. CSVå…¥å‡ºåŠ› ---
    function exportToCSV() {
        let csv = "æ—¥ä»˜,æœ1é«˜,æœ1ä½,æœ2é«˜,æœ2ä½,å¤œ1é«˜,å¤œ1ä½,å¤œ2é«˜,å¤œ2ä½\n";
        records.forEach(r => {
            csv += `${r.fullDate},${r.m1[0]},${r.m1[1]},${r.m2[0]},${r.m2[1]},${r.e1[0]},${r.e1[1]},${r.e2[0]},${r.e2[1]}\n`;
        });
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:'text/csv;charset=utf-8'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `blood_pressure.csv`;
        a.click();
    }

    function importFromCSV(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const lines = e.target.result.split('\n');
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',');
                if (cols.length < 9) continue;
                const entry = {
                    id: Date.now() + i,
                    fullDate: cols[0].trim(),
                    m1: [parseInt(cols[1]), parseInt(cols[2])],
                    m2: [parseInt(cols[3]), parseInt(cols[4])],
                    e1: [parseInt(cols[5]), parseInt(cols[6])],
                    e2: [parseInt(cols[7]), parseInt(cols[8])]
                };
                records = records.filter(r => r.fullDate !== entry.fullDate);
                records.push(entry);
            }
            records.sort((a,b) => new Date(b.fullDate) - new Date(a.fullDate));
            saveAndRender();
            alert('å–ã‚Šè¾¼ã¿å®Œäº†');
        };
        reader.readAsText(file);
    }

    // --- 5. å°åˆ·ãƒ­ã‚¸ãƒƒã‚¯ ---
    function showPrintDialog() {
        document.getElementById('printDialog').style.display = 'flex';
        if (records.length > 0) {
            const dates = records.map(r => new Date(r.fullDate));
            document.getElementById('printStartDate').value = new Date(Math.min(...dates)).toISOString().split('T')[0];
            document.getElementById('printEndDate').value = new Date(Math.max(...dates)).toISOString().split('T')[0];
        }
    }
    function closePrintDialog() { document.getElementById('printDialog').style.display = 'none'; }

    function executePrint() {
        const start = new Date(document.getElementById('printStartDate').value);
        const end = new Date(document.getElementById('printEndDate').value);
        if (isNaN(start) || isNaN(end)) return alert('æ—¥ä»˜ã‚’æŒ‡å®šã—ã¦ãã ã•ã„');

        const recordMap = {};
        records.forEach(r => recordMap[r.fullDate] = r);

        let html = '';
        let current = new Date(start);
        current.setDate(current.getDate() - current.getDay()); // æ—¥æ›œæ—¥é–‹å§‹ã«èª¿æ•´

        const weeks = [];
        while (current <= end) {
            const week = { start: new Date(current), days: [] };
            for (let i = 0; i < 7; i++) {
                const dStr = current.toISOString().split('T')[0];
                week.days.push({ date: new Date(current), data: recordMap[dStr] || null });
                current.setDate(current.getDate() + 1);
            }
            weeks.push(week);
        }

        for (let p = 0; p < Math.ceil(weeks.length / 4); p++) {
            html += `<div class="print-page">`;
            if (p === 0) html += `<div class="print-header"><h2>è¡€åœ§è¨˜éŒ²å¸³</h2><p>${start.toLocaleDateString()} ï½ ${end.toLocaleDateString()}</p></div>`;
            weeks.slice(p * 4, (p + 1) * 4).forEach(w => {
                html += `<div class="week-group"><div class="weekly-summary">${w.start.toLocaleDateString()} é€±</div>`;
                w.days.forEach(d => {
                    const r = d.data;
                    html += `
                        <div class="day-row">
                            <div class="day-date">${d.date.getMonth()+1}/${d.date.getDate()}<br>(${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][d.date.getDay()]})</div>
                            <div class="day-values">
                                <div class="val-m">${r ? r.m1[0]+'/'+r.m1[1] : '--'}</div>
                                <div class="val-e">${r ? r.e1[0]+'/'+r.e1[1] : '--'}</div>
                            </div>
                        </div>`;
                });
                html += `</div>`;
            });
            html += `</div>`;
        }
        const container = document.getElementById('printContainer');
        container.innerHTML = html;
        closePrintDialog();
        setTimeout(() => { window.print(); }, 200);
    }

    // --- 6. ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ² ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker Registered'))
                .catch(err => console.log('Service Worker Registration Failed', err));
        });
    }

    // åˆå›å®Ÿè¡Œ
    saveAndRender();
</script>
</body>
</html>
